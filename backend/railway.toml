[build]
builder = "nixpacks"

[deploy]
healthcheckPath = "/health"
healthcheckTimeout = 600
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 5

[[services]]
name = "plantakeoff-backend"
source = "./backend"

[services.variables]
NODE_ENV = "production"
PORT = "${{ PORT }}"
# DATABASE_URL will be automatically set by Railway when services are linked
# IMPORTANT: Ensure you remove any managed PostgreSQL service from Railway dashboard
# The DATABASE_URL should point to the "postgres" container service below
# Format: postgresql://plantakeoff:${POSTGRES_PASSWORD}@postgres:5432/plantakeoff

[[services]]
name = "plantakeoff-frontend"
source = "./frontend"

# PostgreSQL with PostGIS Container Service
# IMPORTANT: Railway's managed PostgreSQL (via 'railway add --database postgresql') does NOT include PostGIS
# 
# CRITICAL: Before deploying, you MUST:
# 1. Go to Railway dashboard â†’ Remove any managed PostgreSQL service
# 2. Ensure this container service is the only PostgreSQL service
# 3. Railway will auto-link services and set DATABASE_URL
#
# Alternative: Use Railway's PostGIS template: https://railway.com/template/postgis
[[services]]
name = "postgres"
source = "postgis/postgis:15-3.4"

[services.variables]
POSTGRES_DB = "plantakeoff"
POSTGRES_USER = "plantakeoff"
POSTGRES_PASSWORD = "${{ POSTGRES_PASSWORD }}"
# PostGIS extensions are available by default in this image
# The application will enable them on startup via Prisma

[[services]]
name = "redis"
source = "redis:7"
